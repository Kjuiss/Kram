<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Interactive Skills Matrix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0f1220;
      --bg2:#0b0e1a;
      --card:#171a2b;
      --muted:#a9b0c7;
      --text:#e8ecff;
      --accent:#7aa2ff;
      --accent2:#5cf2c7;
      --accent-dark:#3d4b7a;
      --danger:#ff6b6b;
      --slider-track-h: 14px;
      --slider-thumb: 24px;
      --del-size: 22px;
      --del-fs: 14px;
      --bar-bg: #11152b;
      --bar-stroke: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      background-attachment:fixed;
      background-repeat:no-repeat;
      background-size:cover;
      color:var(--text)
    }
    .container{max-width:1160px; margin:0 auto; padding:28px 18px 80px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    .title{display:flex; gap:14px; align-items:center}
    .avatar{
      width:52px; height:52px; border-radius:14px;
      background:linear-gradient(135deg,#1b2a4f,#243b6b);
      display:grid; place-items:center;
      font-weight:800; color:#e8ecff;
    }
    h1{font-size:1.4rem; margin:0}
    .subtitle{margin:2px 0 0; color:var(--muted); font-size:.95rem; white-space:pre-line}
    .subtitle[contenteditable="true"], h1[contenteditable="true"]{
      border:1px dashed transparent;padding:2px 4px;border-radius:6px
    }
    .subtitle[contenteditable="true"]:focus,
    h1[contenteditable="true"]:focus{
      outline:none;border-color:rgba(122,162,255,.5);background:rgba(122,162,255,.08)
    }
    .card{background:rgba(23,26,43,.8); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button,.chip, select{
      background:#1b2140; color:var(--text); border:1px solid rgba(255,255,255,.08);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:600
    }
    button:hover, select:hover{border-color:rgba(122,162,255,.6)}
    button.primary{background:linear-gradient(180deg, #27335f, #1d264b); border-color:#2f3b6c}
    button.ghost{background:transparent}
    .chip{font-size:.9rem; display:inline-flex; align-items:center; gap:6px}
    .chip input{margin:0}
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .tab{
      background:#101633; color:#e8ecff; border:1px solid rgba(255,255,255,.08);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700
    }
    .tab.active{outline:2px solid rgba(122,162,255,.6); background:#0e1532}
    .tab.team-tab{background:#141a32}
    .tab.team-view{
      background:linear-gradient(90deg,#ffd166,#ffe29a);
      color:#000; border-color:#ffd166; font-weight:800
    }
    .tab.team-view.active{outline:3px solid #ffd166; box-shadow:0 0 10px #ffd166}
    .search{
      flex:1; min-width:220px; background:#0f142a; border:1px solid rgba(255,255,255,.08);
      color:#e8ecff; border-radius:12px; padding:10px 12px; outline:none
    }
    .search:focus{box-shadow:0 0 0 3px rgba(122,162,255,.25); border-color:#31407b}
    .ref-select{min-width:170px}
    .category{margin-top:16px; border-radius:14px; padding:10px}
    .category.active{outline:2px solid var(--accent); box-shadow:0 0 0 6px rgba(122,162,255,.12) inset; background:rgba(122,162,255,.06)}
    .category h3{margin:0 0 6px; font-size:1.05rem; color:#cdd5ff; display:flex; align-items:center; gap:8px}
    .marker{display:inline-block; width:8px; height:8px; border-radius:999px; background:var(--accent)}
    .flex-spacer{flex:1 1 auto}
    .grid{display:grid; grid-template-columns:1fr; gap:8px}
    .row{
      display:grid; grid-template-columns: 1fr auto auto; grid-template-rows: auto auto;
      gap:8px 12px; align-items:center; padding:10px 12px; border-radius:12px
    }
    .row:hover{background:rgba(255,255,255,.03)}
    .row .name{grid-column:1/2; grid-row:1/2; font-weight:600}
    .row .right{grid-column:2/3; grid-row:1/2; justify-self:end}
    .row .del{grid-column:3/4; grid-row:1/2; justify-self:end}
    .row .slider{grid-column:1/-1; grid-row:2/3}
    .range{
      appearance:none; width:100%; height:var(--slider-track-h);
      background:#11152b; border-radius:999px; outline:none
    }
    .range::-webkit-slider-thumb{
      appearance:none; width:var(--slider-thumb); height:var(--slider-thumb);
      border-radius:50%; background:var(--accent); box-shadow:0 0 0 3px rgba(122,162,255,.3)
    }
    .range::-moz-range-thumb{
      width:var(--slider-thumb); height:var(--slider-thumb);
      border-radius:50%; background:var(--accent); border:none
    }
    .range::-webkit-slider-runnable-track{
      height:var(--slider-track-h); border-radius:999px;
      background:linear-gradient(90deg, var(--accent) var(--value,0%), #1a2144 var(--value,0%))
    }
    .del{
      border:1px solid rgba(255,255,255,.18); background:#121833; color:#a9b0c7;
      cursor:pointer; display:inline-grid; place-items:center;
      width:var(--del-size); height:var(--del-size); border-radius:8px;
      padding:0; font-size:var(--del-fs); line-height:1;
    }
    .del:hover{color:#fff; border-color:rgba(255,255,255,.35); background:#101633}
    .footer{margin-top:20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap}
    .note{color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      background:#141a32; border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px; font-size:.85rem
    }
    .live-hint{
      position:fixed; z-index:9999; background:#0e1532;
      border:1px solid rgba(255,255,255,.15); padding:8px 10px;
      border-radius:10px; font-size:.85rem;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      pointer-events:none; transform:translate(-50%,-130%);
      opacity:0; transition:opacity .18s ease
    }
    .hidden{display:none}
    .sr-only{
      position:absolute !important; width:1px !important; height:1px !important;
      padding:0 !important; margin:-1px !important; overflow:hidden !important;
      clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important;
    }
    .row.team-row{grid-template-columns:1.2fr 3fr 80px}
    .bar{
      height:10px; background:var(--bar-bg); border-radius:999px;
      position:relative; overflow:hidden
    }
    .bar-fill{
      position:absolute; inset:0 0 0 0; width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      transition:width .2s
    }
    .summary-fill{
      background:var(--accent-dark) !important;
    }

    /* Delta-Badges */
    .delta-chip{
      padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18);
      font-size:.8rem; display:inline-flex; align-items:center; gap:6px; font-weight:700
    }
    .delta-chip .badge{
      display:inline-grid; place-items:center; width:18px; height:18px;
      border-radius:999px; font-size:.72rem; font-weight:900; line-height:1
    }
    .delta-chip .sign{opacity:.95; font-weight:900}
    .delta-peer{
      background:linear-gradient(90deg, rgba(122,162,255,.22), rgba(92,242,199,.22));
      border-color:rgba(122,162,255,.65); color:#d8e4ff
    }
    .delta-peer .badge{
      background:rgba(122,162,255,.25);
      border:1px solid rgba(122,162,255,.65);
      color:#fff;
    }
    .delta-ref{
      background:linear-gradient(90deg, rgba(255,209,102,.22), rgba(255,226,154,.22));
      border-color:#ffd166;
      color:#fff;
    }
    .delta-ref .badge{
      background:rgba(255,209,102,.25);
      border:1px solid #ffd166;
      color:#fff;
    }

    /* PRINT / PDF */
    #print-root{display:none}
    @media print{
      .container{ display:none !important }
      #print-root{ display:block !important }
      .live-hint { display:none !important }
      body { background:white !important; }
    }

    dialog{
      border:none; border-radius:18px; background:var(--card); color:var(--text);
      padding:18px 18px 14px; box-shadow:0 18px 60px rgba(0,0,0,.5); max-width: 920px
    }
    dialog::backdrop{background:rgba(0,0,0,.4)}
    .dialog-row{display:grid; gap:10px; margin:10px 0}
    .dialog-actions{display:flex; justify-content:space-between; gap:10px; align-items:center}

    /* Team-Farbbutton: quadratisch */
    .team-color-square{
      width:34px;
      height:34px;
      border-radius:10px;
      border:2px solid #ffffff55;
      cursor:pointer;
      display:inline-block;
      box-shadow:0 0 0 2px #00000055;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <div class="avatar" id="avatar">TM</div>
        <div>
          <h1 id="display-name" contenteditable="true" spellcheck="false">Kein Team</h1>
          <div class="subtitle" id="subtitle" contenteditable="true" spellcheck="false">Erstelle ein Team, um zu starten.</div>
        </div>
      </div>
      <div class="toolbar">
        <span class="chip hidden" id="peer-pill">Peer: –</span>
        <button id="btn-peer">Peer-Review</button>
        <button id="btn-role-save">Rolle erstellen</button>
        <button id="btn-ref-edit">Referenzen</button>
        <button id="btn-pdf">PDF</button>
        <button id="btn-export-json">Export JSON</button>
        <input type="file" id="import-file" class="hidden" accept="application/json">
        <button id="btn-import">Import JSON</button>
      </div>
    </header>

    <div class="card">
      <!-- Team-Tabs -->
      <div class="tabs" id="team-tabs"></div>

      <!-- Member-Tabs (inkl. Team-Ansicht) -->
      <div class="tabs" id="member-tabs"></div>

      <div class="toolbar" style="margin-bottom:12px">
        <input class="search" id="search" placeholder="Suche nach Skill/Tool…">
        <button id="btn-add-skill" disabled>+ Skill</button>
        <button id="btn-add-cat" disabled>+ Kategorie</button>
        <button id="btn-collapse">Alles zuklappen</button>
        <button id="btn-expand">Alles aufklappen</button>
        <button id="btn-team-manage">Team &amp; Mitglieder</button>
        <button id="btn-team-filter">Team-Filter</button>
        <button id="btn-new-team">+ Team</button>

        <select id="ref-view-level" class="ref-select" title="Referenzprofil Vergleich">
          <option value="">Kein Referenzprofil</option>
          <option value="Junior">Junior</option>
          <option value="Professional">Professional</option>
          <option value="Senior">Senior</option>
          <option value="Lead">Lead</option>
        </select>
        <label class="chip"><input type="checkbox" id="toggle-ref-delta" checked> Ref‑Δ</label>
        <label class="chip"><input type="checkbox" id="toggle-peer-delta" checked> Peer‑Δ</label>
      </div>

      <div id="categories"></div>

      <div class="footer">
        <div class="note">Alle Änderungen (inkl. Peer-Review, Rollen &amp; Referenzen) werden automatisch in <b>Settings.json</b> gespeichert.</div>
        <div class="tag">Shift+←/→ für Feinschritte auf den Slidern</div>
      </div>
    </div>
  </div>

  <!-- PRINT ROOT (für PDF-Ausgabe) -->
  <div id="print-root"></div>

  <!-- Dialog: neuen Skill hinzufügen -->
  <dialog id="dlg-add-skill">
    <h3>Neuen Skill hinzufügen</h3>
    <div class="dialog-row">
      <label>Name<br><input id="add-skill-name" class="search" placeholder="z.B. Motion Specs, C++ Basics"></label>
      <label>Startwert (0–5)<br><input id="add-skill-val" type="number" min="0" max="5" value="0" class="search"></label>
    </div>
    <div class="dialog-actions">
      <div><span id="add-skill-cat-name" class="tag">Kategorie</span></div>
      <div>
        <button id="add-skill-cancel">Abbrechen</button>
        <button class="primary" id="add-skill-confirm">Hinzufügen</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog: Team & Mitglieder bearbeiten -->
  <dialog id="dlg-team">
    <h3>Team &amp; Mitglieder bearbeiten</h3>
    <div class="dialog-row" style="grid-template-columns:1fr auto; align-items:center">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <label style="flex:1 1 200px;">Team-Name<br><input id="team-name-input" class="search" placeholder="Teamname"></label>
        <div>
          <div>Team-Farbe</div>
          <div id="team-color-square" class="team-color-square"></div>
          <input id="team-color-input" type="color" class="hidden">
        </div>
      </div>
    </div>
    <div class="dialog-row">
      <div id="team-members-list"></div>
    </div>
    <div class="dialog-actions">
      <button id="team-add-member">+ Mitglied hinzufügen</button>
      <div>
        <button id="team-delete" class="ghost">Team löschen</button>
        <button id="team-cancel">Abbrechen</button>
        <button id="team-save" class="primary">Übernehmen</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog: Team-Filter -->
  <dialog id="dlg-team-filter">
    <h3>Team-Filter</h3>
    <div class="dialog-row" style="max-height: 46vh; overflow:auto">
      <div id="team-filter-list"></div>
    </div>
    <div class="dialog-actions">
      <div>
        <button id="filter-all" class="ghost">Alle</button>
        <button id="filter-none" class="ghost">Keine</button>
      </div>
      <div>
        <button id="filter-cancel">Abbrechen</button>
        <button id="filter-save" class="primary">Übernehmen</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog: Peer-Review -->
  <dialog id="dlg-peer">
    <h3>Peer-Review starten</h3>
    <div class="dialog-row">
      <label>Wer bewertet?<br><select id="peer-reviewer" class="search"></select></label>
      <label>Wen bewertest du?<br><select id="peer-reviewee" class="search"></select></label>
    </div>
    <div class="dialog-actions">
      <button id="peer-cancel">Abbrechen</button>
      <button id="peer-start" class="primary">Starten</button>
    </div>
    <p class="note">Im Peer-Review-Modus bearbeitest du nur deine Bewertung für die ausgewählte Person. Das Original bleibt erhalten.</p>
  </dialog>

  <!-- Dialog: Referenzprofile -->
  <dialog id="dlg-ref">
    <h3>Referenzprofile bearbeiten</h3>
    <div class="dialog-row" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <label>Rolle<br>
        <select id="ref-role-select" class="search"></select>
      </label>
      <label>Level<br>
        <select id="ref-level-select" class="search">
          <option>Junior</option>
          <option>Professional</option>
          <option>Senior</option>
          <option>Lead</option>
        </select>
      </label>
      <button id="ref-fill-defaults" class="ghost" title="Alle auf Standard setzen">Alle = Standard</button>
      <input id="ref-search" class="search" placeholder="Filter… (Skill/Kategorie)">
    </div>
    <div class="dialog-row" style="max-height:55vh; overflow:auto">
      <div id="ref-editor-grid"></div>
    </div>
    <div class="dialog-actions">
      <div class="note">Referenzwerte (0–5) werden für Ref‑Δ genutzt und erscheinen optional im PDF.</div>
      <div>
        <button id="ref-cancel">Abbrechen</button>
        <button id="ref-save" class="primary">Schließen</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------------------------
    // Helpers & Konstanten
    // ---------------------------
    const byId = id => document.getElementById(id);
    const clamp = (x,min=0,max=5) => Math.max(min, Math.min(max, x));
    const clamp5 = x => clamp(Math.round(Number(x)||0), 0, 5);
    const pct5  = v => (clamp(Number(v),0,5)/5)*100;
    const initials = full => {
      const p=String(full||'').trim().split(/\s+/);
      const s=((p[0]||'').charAt(0)+(p[p.length-1]||'').charAt(0)).toUpperCase();
      return s || 'TM';
    };
    const describeLevel5 = v => ([
      '0: Keine Praxis',
      '1: Anfänger',
      '2: Basics',
      '3: Fortgeschritten',
      '4: Senior/Expert',
      '5: Principal/Lead'
    ][clamp5(v)]);
    const skillKey = (cat, skill) => `${cat}::${skill}`;
    const escapeHtml = str => String(str||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
    const newId = prefix => `${prefix}_${Math.random().toString(36).slice(2,9)}`;

    const REF_LEVELS = ['Junior','Professional','Senior','Lead'];
    const REF_DEFAULTS = {
      Junior:1,
      Professional:3,
      Senior:4,
      Lead:5
    };

    function darkerHex(hex, factor=0.6){
      if(!/^#?[0-9a-f]{6}$/i.test(hex||'')) return '#0f1220';
      const h = hex.replace('#','');
      let r = parseInt(h.slice(0,2),16);
      let g = parseInt(h.slice(2,4),16);
      let b = parseInt(h.slice(4,6),16);
      r = Math.max(0, Math.min(255, Math.round(r*factor)));
      g = Math.max(0, Math.min(255, Math.round(g*factor)));
      b = Math.max(0, Math.min(255, Math.round(b*factor)));
      return `rgb(${r},${g},${b})`;
    }

    function defaultProfile(){
      return {
        meta: {
          owner: '',
          role: '',
          subtitle: '',
          updated: new Date().toISOString(),
          refLevel: '',
          showRefDelta: true,
          showPeerDelta: true
        },
        categories: []
      };
    }

    function ensureProfileDefaults(p){
      if(!p.meta || typeof p.meta!=='object') p.meta = {};
      if(typeof p.meta.owner!=='string') p.meta.owner='';
      if(typeof p.meta.role!=='string') p.meta.role='';
      if(typeof p.meta.subtitle!=='string') p.meta.subtitle='';
      if(typeof p.meta.updated!=='string') p.meta.updated=new Date().toISOString();
      if(typeof p.meta.refLevel!=='string') p.meta.refLevel='';
      if(typeof p.meta.showRefDelta!=='boolean') p.meta.showRefDelta=true;
      if(typeof p.meta.showPeerDelta!=='boolean') p.meta.showPeerDelta=true;
      if(!Array.isArray(p.categories)) p.categories=[];
    }

    function defaultSettings(){
      const baseRoles = {
        "POs": { "label": "POs", "refs": {} },
        "PjMs": { "label": "PjMs", "refs": {} }
      };
      REF_LEVELS.forEach(l=>{
        Object.keys(baseRoles).forEach(k=>{
          baseRoles[k].refs[l] = {};
        });
      });
      return {
        schemaVersion: 23,
        teams: [],
        activeTeamId: null,
        activeMemberId: null,
        data: {},
        peer: {},
        roles: baseRoles
      };
    }

    let SETTINGS = defaultSettings();
    let saveTimer = null;
    let activeCategoryIdx = 0;

    const PEER_MODE = {
      active: false,
      reviewerId: null,
      revieweeId: null
    };

    const hintEl = (()=>{ const d=document.createElement('div'); d.className='live-hint'; document.body.appendChild(d); return d; })();
    let hintTimer=null;
    function showHint(range, name, value){
      const r=range.getBoundingClientRect();
      const pct=value/5;
      const x=r.left + r.width * pct;
      const min=16, max=window.innerWidth - 16;
      hintEl.textContent=`${name}: ${value} — ${describeLevel5(value)}`;
      hintEl.style.left=Math.max(min, Math.min(max, x))+'px';
      hintEl.style.top=(r.top - 8)+'px';
      hintEl.style.opacity='1';
      clearTimeout(hintTimer);
      hintTimer=setTimeout(()=>{ hintEl.style.opacity='0'; }, 900);
    }

    function getAllRoles(){
      const r = (SETTINGS.roles && typeof SETTINGS.roles==='object') ? SETTINGS.roles : {};
      return Object.keys(r).map(key=>({
        key,
        label: r[key].label || key
      }));
    }

    async function saveRoleTemplate(roleKey, tmpl){
      try{
        await fetch('/role/' + encodeURIComponent(roleKey), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(tmpl)
        });
      }catch(e){
        console.warn('Rollen-Template konnte nicht gespeichert werden:', roleKey, e);
      }
    }

    function ensureRoleExistsForLabel(label){
      const lab = (label||'').trim();
      if(!lab) return '';
      if(!SETTINGS.roles || typeof SETTINGS.roles!=='object') SETTINGS.roles = {};
      for(const key of Object.keys(SETTINGS.roles)){
        if(SETTINGS.roles[key].label === lab) return key;
      }
      let safeKey = lab.replace(/[^a-z0-9_\-]/gi,'');
      if(!safeKey) safeKey = 'Role_' + Math.random().toString(36).slice(2,7);
      if(!SETTINGS.roles[safeKey]){
        SETTINGS.roles[safeKey] = { label: lab, refs:{} };
        REF_LEVELS.forEach(l=>{
          SETTINGS.roles[safeKey].refs[l] = {};
        });
        saveRoleTemplate(safeKey, { roleKey: safeKey, label: lab, categories: [] });
      }
      return safeKey;
    }

    // ---------------------------
    // Settings laden/speichern
    // ---------------------------
    function migrateSettings(obj){
      if(!obj || typeof obj!=='object') return defaultSettings();
      if(typeof obj.schemaVersion!=='number' || obj.schemaVersion < 23) obj.schemaVersion = 23;
      if(!Array.isArray(obj.teams)) obj.teams = [];
      if(!obj.data || typeof obj.data!=='object') obj.data = {};
      if(typeof obj.activeTeamId!=='string' && obj.activeTeamId!==null) obj.activeTeamId = null;
      if(typeof obj.activeMemberId!=='string' && obj.activeMemberId!==null) obj.activeMemberId = null;
      if(!obj.peer || typeof obj.peer!=='object') obj.peer = {};
      if(!obj.roles || typeof obj.roles!=='object') obj.roles = {};
      if(!obj.roles.POs) obj.roles.POs = { label:'POs', refs:{} };
      if(!obj.roles.PjMs) obj.roles.PjMs = { label:'PjMs', refs:{} };
      Object.keys(obj.roles).forEach(key=>{
        const r = obj.roles[key];
        if(!r || typeof r!=='object') obj.roles[key] = { label:key, refs:{} };
        if(typeof obj.roles[key].label!=='string') obj.roles[key].label = key;
        if(!obj.roles[key].refs || typeof obj.roles[key].refs!=='object') obj.roles[key].refs = {};
        REF_LEVELS.forEach(l=>{
          if(!obj.roles[key].refs[l] || typeof obj.roles[key].refs[l]!=='object') obj.roles[key].refs[l] = {};
        });
      });
      return obj;
    }

    async function loadSettings(){
      try{
        const resp = await fetch('Settings.json', { cache:'no-store' });
        if(!resp.ok){
          SETTINGS = defaultSettings();
          return;
        }
        const obj = await resp.json();
        SETTINGS = migrateSettings(obj);
      }catch(e){
        console.warn('Settings.json konnte nicht geladen werden:', e);
        SETTINGS = defaultSettings();
      }
    }

    function scheduleSave(){
      if(saveTimer) return;
      saveTimer = setTimeout(doSave, 400);
    }

    async function doSave(){
      saveTimer = null;
      try{
        await fetch('/settings', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(SETTINGS)
        });
      }catch(e){
        console.warn('Automatisches Speichern fehlgeschlagen:', e);
      }
    }

    // ---------------------------
    // Teams & Mitglieder
    // ---------------------------
    function getTeamById(id){
      return SETTINGS.teams.find(t=>t.id===id) || null;
    }

    function getActiveTeam(){
      return getTeamById(SETTINGS.activeTeamId);
    }

    function getMembers(team){
      return team ? (team.members || []) : [];
    }

    function findMemberById(id){
      for(const t of SETTINGS.teams){
        const m = (t.members||[]).find(x=>x.id===id);
        if(m) return m;
      }
      return null;
    }

    function ensureProfile(memberId){
      if(!SETTINGS.data) SETTINGS.data = {};
      if(!SETTINGS.data[memberId]){
        SETTINGS.data[memberId] = defaultProfile();
      }
      const p = SETTINGS.data[memberId];
      ensureProfileDefaults(p);
      return p;
    }

    function selectedMemberIds(team){
      if(!team) return [];
      const all = getMembers(team).map(m=>m.id);
      const filter = team.filterMemberIds;
      if(Array.isArray(filter) && filter.length){
        return filter.filter(id=>all.includes(id));
      }
      return all;
    }

    function computeTeamAggregatedProfile(team){
      const ids = selectedMemberIds(team);
      const agg = new Map();
      ids.forEach(id=>{
        const prof = ensureProfile(id);
        (prof.categories||[]).forEach(cat=>{
          if(!agg.has(cat.name)) agg.set(cat.name, new Map());
          const m = agg.get(cat.name);
          (cat.items||[]).forEach(it=>{
            if(!m.has(it.n)) m.set(it.n,{sum:0,count:0});
            const rec=m.get(it.n);
            rec.sum += Number(it.v)||0;
            rec.count += 1;
          });
        });
      });

      const categories=[];
      agg.forEach((m,catName)=>{
        const items=[];
        m.forEach((rec,name)=>{
          const v = rec.count ? clamp5(Math.round(rec.sum/rec.count)) : 0;
          items.push({n:name, v});
        });
        items.sort((a,b)=>b.v-a.v);
        categories.push({name:catName, items});
      });
      categories.sort((a,b)=>a.name.localeCompare(b.name,'de'));
      return {
        meta:{ owner:team.name, role:'', subtitle:'Team-Ansicht', updated:new Date().toISOString() },
        categories
      };
    }

    function createTeam(name){
      const id = newId('team');
      const team = {
        id,
        name: name || 'Neues Team',
        color: '#ffd166',
        members: [],
        filterMemberIds: null,
        activeMemberId: null
      };
      SETTINGS.teams.push(team);
      SETTINGS.activeTeamId = id;
      SETTINGS.activeMemberId = null;
      scheduleSave();
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function deleteTeam(id){
      const idx = SETTINGS.teams.findIndex(t=>t.id===id);
      if(idx<0) return;
      const team = SETTINGS.teams[idx];
      const memberIds = (team.members||[]).map(m=>m.id);
      memberIds.forEach(mid=>{ if(SETTINGS.data && SETTINGS.data[mid]) delete SETTINGS.data[mid]; });
      SETTINGS.peer = {};
      SETTINGS.teams.splice(idx,1);
      if(SETTINGS.activeTeamId===id){
        SETTINGS.activeTeamId = SETTINGS.teams[0]?.id || null;
        SETTINGS.activeMemberId = SETTINGS.activeTeamId ? getTeamById(SETTINGS.activeTeamId).activeMemberId || null : null;
      }
      exitPeerMode();
      scheduleSave();
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function setActiveTeam(id){
      SETTINGS.activeTeamId = id;
      const team = getTeamById(id);
      SETTINGS.activeMemberId = team ? team.activeMemberId || null : null;
      exitPeerMode();
      scheduleSave();
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function setActiveMember(idOrNull){
      SETTINGS.activeMemberId = idOrNull;
      const team = getActiveTeam();
      if(team){
        team.activeMemberId = idOrNull;
      }
      exitPeerMode();
      scheduleSave();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function applyThemeForTeam(team){
      const root=document.documentElement;
      const col = (team && team.color) || '#7aa2ff';
      root.style.setProperty('--accent', col);
      root.style.setProperty('--accent2', col);
      root.style.setProperty('--accent-dark', darkerHex(col, 0.6));
      // Hintergrund an Team-Farbe anpassen (deutlich dunkler)
      const bg1 = darkerHex(col, 0.25);
      const bg2 = darkerHex(col, 0.15);
      root.style.setProperty('--bg', bg1);
      root.style.setProperty('--bg2', bg2);
    }

    function resolveRoleKey(member, profile){
      const roles = SETTINGS.roles || {};
      const metaRole = (profile.meta && profile.meta.role || '').trim();
      const memberRole = (member && member.role || '').trim();

      if(metaRole && roles[metaRole]) return metaRole;
      for(const key of Object.keys(roles)){
        if(roles[key].label === metaRole) return key;
      }
      if(memberRole && roles[memberRole]) return memberRole;
      for(const key of Object.keys(roles)){
        if(roles[key].label === memberRole) return key;
      }
      return metaRole || memberRole || '';
    }

    function updateHeader(){
      const nameEl = byId('display-name');
      const subEl  = byId('subtitle');
      const avatar = byId('avatar');
      const refSelect = byId('ref-view-level');
      const refToggle = byId('toggle-ref-delta');
      const peerToggle = byId('toggle-peer-delta');

      const team   = getActiveTeam();
      const memberId = SETTINGS.activeMemberId;

      if(!team){
        nameEl.textContent = 'Kein Team';
        subEl.textContent  = 'Erstelle ein Team, um zu starten.';
        avatar.textContent = 'TM';
        document.title     = 'Interactive Skills Matrix';
        applyThemeForTeam(null);
        if(refSelect){ refSelect.value=''; refSelect.disabled=true; }
        if(refToggle){ refToggle.checked=false; refToggle.disabled=true; }
        if(peerToggle){ peerToggle.checked=false; peerToggle.disabled=true; }
        return;
      }

      applyThemeForTeam(team);

      if(!memberId){
        nameEl.textContent = team.name || 'Team';
        subEl.textContent  = 'Team-Ansicht — Gesamtkompetenz über alle Mitglieder';
        avatar.textContent = 'TM';
        document.title     = `${team.name} — Skills Matrix`;
        if(refSelect){ refSelect.value=''; refSelect.disabled=true; }
        if(refToggle){ refToggle.checked=false; refToggle.disabled=true; }
        if(peerToggle){ peerToggle.checked=false; peerToggle.disabled=true; }
      } else {
        const m = findMemberById(memberId);
        const prof = ensureProfile(memberId);
        nameEl.textContent = m ? m.name : 'Mitglied';

        const parts = [];
        const roleKey = resolveRoleKey(m, prof);
        const roleObj = SETTINGS.roles && SETTINGS.roles[roleKey];
        const roleLabel = roleObj ? roleObj.label : prof.meta.role || (m && m.role) || '';
        if(roleLabel) parts.push(roleLabel);
        if(team.name) parts.push(`Team: ${team.name}`);

        const customSubtitle = (prof.meta.subtitle || '').trim();
        const autoSubtitle = parts.length ? parts.join(' — ') : '';
        subEl.textContent = customSubtitle || autoSubtitle || 'Profil-Ansicht';

        avatar.textContent = initials(m ? m.name : 'TM');
        document.title     = `${m ? m.name+' — ' : ''}${team.name || 'Team'} — Skills Matrix`;

        if(refSelect){
          refSelect.disabled = false;
          refSelect.value = prof.meta.refLevel || '';
        }
        if(refToggle){
          refToggle.disabled = false;
          refToggle.checked = prof.meta.showRefDelta !== false;
        }
        if(peerToggle){
          peerToggle.disabled = false;
          peerToggle.checked = prof.meta.showPeerDelta !== false;
        }
      }
    }

    // ---------------------------
    // Peer-Review
    // ---------------------------
    function ensurePeerRoot(){
      if(!SETTINGS.peer || typeof SETTINGS.peer!=='object') SETTINGS.peer = {};
    }

    function getPeerMap(reviewerId, revieweeId){
      ensurePeerRoot();
      if(!SETTINGS.peer[reviewerId]) SETTINGS.peer[reviewerId] = {};
      if(!SETTINGS.peer[reviewerId][revieweeId]) SETTINGS.peer[reviewerId][revieweeId] = {};
      return SETTINGS.peer[reviewerId][revieweeId];
    }

    function setPeerRating(reviewerId, revieweeId, catName, skillName, value){
      const m = getPeerMap(reviewerId, revieweeId);
      m[skillKey(catName, skillName)] = clamp5(value);
    }

    function getPeerRating(reviewerId, revieweeId, catName, skillName){
      ensurePeerRoot();
      const m = SETTINGS.peer?.[reviewerId]?.[revieweeId];
      if(!m) return null;
      const v = m[skillKey(catName, skillName)];
      return typeof v === 'number' ? clamp5(v) : null;
    }

    function peerAverageForReviewee(revieweeId, catName, skillName){
      ensurePeerRoot();
      const k = skillKey(catName, skillName);
      const vals=[];
      for(const reviewerId of Object.keys(SETTINGS.peer)){
        const map = SETTINGS.peer[reviewerId]?.[revieweeId];
        if(map && typeof map[k]==='number'){
          vals.push(clamp5(map[k]));
        }
      }
      if(!vals.length) return null;
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      return clamp5(Math.round(avg));
    }

    function makePeerBadge(delta){
      const span = document.createElement('span');
      span.className = 'delta-chip delta-peer';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = '⇄';

      const sign = document.createElement('span');
      sign.className = 'sign';
      sign.textContent = (delta > 0 ? '+' : '') + String(delta);

      const abs = Math.abs(delta);
      let base;
      if (delta > 0) {
        base = [0, 180, 110]; // grün
      } else if (delta < 0) {
        base = [210, 70, 70]; // rot
      } else {
        base = [220, 190, 0]; // gelb
      }

      let bgAlpha = 0.18;
      let badgeAlpha = 0.28;
      let borderAlpha = 0.65;

      if (abs >= 3) {
        bgAlpha = 0.40;
        badgeAlpha = 0.65;
      } else if (abs >= 2) {
        bgAlpha = 0.30;
        badgeAlpha = 0.45;
      } else if (abs >= 1) {
        bgAlpha = 0.22;
        badgeAlpha = 0.35;
      } else {
        bgAlpha = 0.18;
        badgeAlpha = 0.30;
      }

      const [r, g, b] = base;
      span.style.backgroundColor = `rgba(${r},${g},${b},${bgAlpha})`;
      span.style.borderColor      = `rgba(${r},${g},${b},${borderAlpha})`;
      badge.style.backgroundColor = `rgba(${r},${g},${b},${badgeAlpha})`;
      badge.style.borderColor     = `rgba(${r},${g},${b},${borderAlpha})`;
      span.style.color = '#fff';
      badge.style.color = '#fff';

      span.append(badge, document.createTextNode('Δ'), sign);
      return span;
    }

    function makeRefBadge(delta, refVal, level){
      const span = document.createElement('span');
      span.className = 'delta-chip delta-ref';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = '★';

      const sign = document.createElement('span');
      sign.className = 'sign';
      sign.textContent = (delta > 0 ? '+' : '') + String(delta);

      const abs = Math.abs(delta);
      let base;
      if (delta > 0) {
        base = [0, 180, 110]; // grün
      } else if (delta < 0) {
        base = [210, 70, 70]; // rot
      } else {
        base = [220, 190, 0]; // gelb
      }

      let bgAlpha = 0.18;
      let badgeAlpha = 0.28;
      let borderAlpha = 0.65;

      if (abs >= 3) {
        bgAlpha = 0.40;
        badgeAlpha = 0.65;
      } else if (abs >= 2) {
        bgAlpha = 0.30;
        badgeAlpha = 0.45;
      } else if (abs >= 1) {
        bgAlpha = 0.22;
        badgeAlpha = 0.35;
      } else {
        bgAlpha = 0.18;
        badgeAlpha = 0.30;
      }

      const [r, g, b] = base;
      span.style.backgroundColor = `rgba(${r},${g},${b},${bgAlpha})`;
      span.style.borderColor      = `rgba(${r},${g},${b},${borderAlpha})`;
      badge.style.backgroundColor = `rgba(${r},${g},${b},${badgeAlpha})`;
      badge.style.borderColor     = `rgba(${r},${g},${b},${borderAlpha})`;
      span.style.color = '#fff';
      badge.style.color = '#fff';

      span.title = `Referenz ${level}: ${refVal}`;
      span.append(badge, document.createTextNode('Δ'), sign);
      return span;
    }

    function enterPeerMode(reviewerId, revieweeId){
      PEER_MODE.active = true;
      PEER_MODE.reviewerId = reviewerId;
      PEER_MODE.revieweeId = revieweeId;
      const pill = byId('peer-pill');
      const reviewer = findMemberById(reviewerId);
      const reviewee = findMemberById(revieweeId);
      if(pill){
        pill.classList.remove('hidden');
        pill.textContent = `Peer: ${(reviewer?.name||'')} → ${(reviewee?.name||'')}`;
      }
      SETTINGS.activeMemberId = revieweeId;
      const team = getActiveTeam();
      if(team) team.activeMemberId = revieweeId;
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function exitPeerMode(){
      PEER_MODE.active = false;
      PEER_MODE.reviewerId = null;
      PEER_MODE.revieweeId = null;
      const pill = byId('peer-pill');
      if(pill) pill.classList.add('hidden');
    }

    function buildPeerDialog(){
      const team = getActiveTeam();
      const members = team ? getMembers(team) : [];
      const selReviewer = byId('peer-reviewer');
      const selReviewee = byId('peer-reviewee');
      selReviewer.innerHTML='';
      selReviewee.innerHTML='';

      members.forEach(m=>{
        const o1=document.createElement('option');
        o1.value=m.id; o1.textContent=m.name || 'Mitglied';
        selReviewer.appendChild(o1);

        const o2=document.createElement('option');
        o2.value=m.id; o2.textContent=m.name || 'Mitglied';
        selReviewee.appendChild(o2);
      });

      const activeMember = SETTINGS.activeMemberId;
      if(activeMember){
        selReviewer.value = activeMember;
        const other = members.find(m=>m.id!==activeMember);
        if(other) selReviewee.value = other.id;
      }
    }

    // ---------------------------
    // Rollen / Referenzwerte
    // ---------------------------
    async function loadRoleTemplate(roleKey){
      const fileName = roleKey + '.json';
      try{
        const resp = await fetch(fileName, { cache:'no-store' });
        if(!resp.ok) return { roleKey, label: roleKey, categories: [] };
        const json = await resp.json();
        if(!Array.isArray(json.categories)) json.categories=[];
        return json;
      }catch(e){
        console.warn('Rollen-Template konnte nicht geladen werden:', roleKey, e);
        return { roleKey, label: roleKey, categories: [] };
      }
    }

    async function applyRoleTemplateToMember(memberId, roleKey){
      if(!roleKey) return;
      const tmpl = await loadRoleTemplate(roleKey);
      if(!tmpl || !Array.isArray(tmpl.categories)) return;
      const prof = ensureProfile(memberId);
      prof.categories = tmpl.categories.map(cat=>({
        name: cat.name,
        items: (cat.items||[]).map(it=>({ n: it.n, v: clamp5(it.v) }))
      }));
      prof.meta.updated = new Date().toISOString();
    }

    function ensureRoleRefs(roleKey){
      if(!SETTINGS.roles || typeof SETTINGS.roles!=='object') SETTINGS.roles = {};
      if(!SETTINGS.roles[roleKey]) SETTINGS.roles[roleKey] = { label: roleKey, refs:{} };
      const r = SETTINGS.roles[roleKey];
      if(!r.refs || typeof r.refs!=='object') r.refs = {};
      REF_LEVELS.forEach(l=>{
        if(!r.refs[l] || typeof r.refs[l]!=='object') r.refs[l] = {};
      });
      return r.refs;
    }

    function getRefVal(roleKey, level, catName, skillName){
      if(!roleKey || !level) return null;
      const roles = SETTINGS.roles || {};
      const r = roles[roleKey];
      const key = skillKey(catName, skillName);
      if(r && r.refs && r.refs[level] && typeof r.refs[level][key]==='number'){
        return clamp5(r.refs[level][key]);
      }
      const base = REF_DEFAULTS[level];
      return typeof base==='number' ? base : null;
    }

    function syncProfileWithRoleTemplateIfNeeded(memberId){
      const member = findMemberById(memberId);
      if(!member) return;
      const prof = ensureProfile(memberId);
      const roleKey = resolveRoleKey(member, prof);
      if(!roleKey) return;
      const roles = SETTINGS.roles || {};
      const label = (roles[roleKey] && roles[roleKey].label) || roleKey;

      const tmpl = {
        roleKey,
        label,
        categories: (prof.categories || []).map(cat=>({
          name: cat.name,
          items: (cat.items || []).map(it=>({ n: it.n, v: clamp5(it.v) }))
        }))
      };
      saveRoleTemplate(roleKey, tmpl);
    }

    function propagateRoleStructureFromMember(memberId){
      const member = findMemberById(memberId);
      if(!member) return;
      const prof = ensureProfile(memberId);
      const roleKey = resolveRoleKey(member, prof);
      if(!roleKey) return;

      const canonicalCats = (prof.categories || []).map(cat => ({
        name: cat.name,
        items: (cat.items || []).map(it => ({ n: it.n }))
      }));

      SETTINGS.teams.forEach(team=>{
        (team.members || []).forEach(m=>{
          const mp = ensureProfile(m.id);
          const memberRoleKey = resolveRoleKey(m, mp);
          if(memberRoleKey !== roleKey) return;

          const oldCats = mp.categories || [];
          const catMap = new Map(oldCats.map(c=>[c.name, c]));
          const newCats = canonicalCats.map(cSpec=>{
            const existing = catMap.get(cSpec.name);
            const itemsMap = existing ? new Map((existing.items||[]).map(i=>[i.n, i])) : new Map();
            const newItems = cSpec.items.map(itSpec=>{
              const ex = itemsMap.get(itSpec.n);
              return { n: itSpec.n, v: ex ? clamp5(ex.v) : 0 };
            });
            return { name: cSpec.name, items: newItems };
          });
          mp.categories = newCats;
          mp.meta.updated = new Date().toISOString();
        });
      });

      syncProfileWithRoleTemplateIfNeeded(memberId);
      scheduleSave();
    }

    // ---------------------------
    // Rendering: Team-Tabs
    // ---------------------------
    function renderTeamTabs(){
      const host = byId('team-tabs');
      host.innerHTML = '';
      SETTINGS.teams.forEach(team=>{
        const btn = document.createElement('button');
        btn.className = 'tab team-tab';
        if(team.id === SETTINGS.activeTeamId) btn.classList.add('active');
        btn.textContent = team.name || 'Team';
        btn.style.borderColor = team.color || '#ffd166';
        btn.onclick = ()=> setActiveTeam(team.id);
        host.appendChild(btn);
      });
      if(!SETTINGS.teams.length){
        const info = document.createElement('span');
        info.className = 'tag';
        info.textContent = 'Noch kein Team – mit „+ Team“ ein neues anlegen.';
        host.appendChild(info);
      }
    }

    // ---------------------------
    // Rendering: Member-Tabs
    // ---------------------------
    function renderMemberTabs(){
      const host = byId('member-tabs');
      host.innerHTML = '';
      const team = getActiveTeam();
      if(!team){
        return;
      }
      const members = getMembers(team);

      members.forEach(m=>{
        const btn = document.createElement('button');
        btn.className = 'tab';
        if(SETTINGS.activeMemberId === m.id) btn.classList.add('active');
        btn.dataset.memberId = m.id;
        btn.textContent = m.name || 'Mitglied';
        btn.onclick = ()=> setActiveMember(m.id);
        host.appendChild(btn);
      });

      const teamTab = document.createElement('button');
      teamTab.className = 'tab team-view';
      if(!SETTINGS.activeMemberId) teamTab.classList.add('active');
      teamTab.textContent = 'Team';
      teamTab.onclick = ()=> setActiveMember(null);
      host.appendChild(teamTab);
    }

    // ---------------------------
    // Rendering: Kategorien & Skills
    // ---------------------------
    function renderCategories(){
      const root = byId('categories');
      root.innerHTML = '';

      const team = getActiveTeam();
      const search = (byId('search').value || '').trim().toLowerCase();
      const isTeamView = !SETTINGS.activeMemberId;

      const btnAddSkill = byId('btn-add-skill');
      const btnAddCat   = byId('btn-add-cat');
      const canEdit = !!SETTINGS.activeMemberId && !PEER_MODE.active;

      btnAddSkill.disabled = !canEdit;
      btnAddCat.disabled   = !canEdit;

      if(!team){
        const note = document.createElement('div');
        note.className = 'tag';
        note.style.marginTop = '8px';
        note.textContent = 'Kein Team vorhanden. Klicke auf „+ Team“, um ein neues Team anzulegen.';
        root.appendChild(note);
        return;
      }

      if(isTeamView){
        const members = getMembers(team);
        const countSel = selectedMemberIds(team).length;
        const infoBar = document.createElement('div');
        infoBar.className = 'tag';
        infoBar.style.marginBottom = '8px';
        infoBar.textContent = `Team-Ansicht: ${countSel} von ${members.length} Mitgliedern im Filter.`;
        root.appendChild(infoBar);
      }

      let profile;
      if(isTeamView){
        profile = computeTeamAggregatedProfile(team);
      } else {
        profile = ensureProfile(SETTINGS.activeMemberId);
      }

      let member=null, memberMeta=null, showRefDelta=false, showPeerDelta=false, refLevel='', roleKey='';
      if(!isTeamView){
        member = findMemberById(SETTINGS.activeMemberId);
        memberMeta = profile.meta || {};
        showRefDelta = memberMeta.showRefDelta !== false;
        showPeerDelta = memberMeta.showPeerDelta !== false;
        refLevel = memberMeta.refLevel || '';
        roleKey = resolveRoleKey(member, profile);
      }

      const categories = profile.categories || [];
      categories.forEach((cat, idx)=>{
        const hasMatch = !search || cat.name.toLowerCase().includes(search) ||
          (cat.items||[]).some(it=> it.n.toLowerCase().includes(search));
        if(!hasMatch) return;

        const section = document.createElement('section');
        section.className = 'category';
        if(idx === activeCategoryIdx && canEdit) section.classList.add('active');

        const h3 = document.createElement('h3');
        const marker = document.createElement('span');
        marker.className='marker';
        const titleSpan = document.createElement('span');
        titleSpan.textContent = cat.name;
        titleSpan.style.cursor = canEdit ? 'pointer' : 'default';
        const spacer = document.createElement('div');
        spacer.className='flex-spacer';

        h3.append(marker, titleSpan, spacer);
        section.appendChild(h3);

        if(canEdit){
          titleSpan.title = 'Klick zum Umbenennen';
          titleSpan.onclick = ()=>{
            const memberId = SETTINGS.activeMemberId;
            if(!memberId) return;
            const currentName = cat.name;
            const neu = prompt('Neuer Kategoriename:', currentName);
            if(!neu || !neu.trim() || neu.trim() === currentName) return;
            const confirmChange = confirm('Bist du sicher, dass du diesen Kategorienamen ändern willst?');
            if(!confirmChange) return;
            cat.name = neu.trim();
            const prof = ensureProfile(memberId);
            prof.meta.updated = new Date().toISOString();
            propagateRoleStructureFromMember(memberId);
            renderCategories();
          };
          h3.onclick = (ev)=>{
            if(ev.target === titleSpan) return; // Name-Klick handled oben
            activeCategoryIdx = idx;
            renderCategories();
          };
        }

        // Kategorie-Ø + Balken
        const items = cat.items || [];
        let avgValue = 0;
        const summary = document.createElement('div');
        summary.style.display = 'flex';
        summary.style.alignItems = 'center';
        summary.style.gap = '8px';
        summary.style.margin = '4px 0 6px';

        const summaryLabel = document.createElement('span');
        summaryLabel.className = 'tag';

        const summaryBar = document.createElement('div');
        summaryBar.className = 'bar';
        const summaryFill = document.createElement('div');
        summaryFill.className = 'bar-fill summary-fill';
        summaryBar.appendChild(summaryFill);

        function recalcSummary(){
          const xs = cat.items || [];
          const sum = xs.reduce((s, it)=> s + (Number(it.v)||0), 0);
          avgValue = xs.length ? (sum / xs.length) : 0;
          summaryLabel.textContent = `Ø ${avgValue.toFixed(1)} (0–5)`;
          summaryFill.style.width = Math.max(0, Math.min(100, (avgValue/5)*100)) + '%';
        }
        recalcSummary();

        summary.append(summaryLabel, summaryBar);
        section.appendChild(summary);

        const grid = document.createElement('div');
        grid.className = 'grid';

        if(isTeamView){
          (cat.items||[]).forEach(it=>{
            const row = document.createElement('div');
            row.className = 'row team-row';
            const name = document.createElement('div');
            name.className = 'name';
            name.textContent = it.n;
            const bar = document.createElement('div');
            bar.className = 'bar';

            const fill = document.createElement('div');
            fill.className = 'bar-fill';
            fill.style.width = pct5(it.v) + '%';
            bar.appendChild(fill);

            const val = document.createElement('div');
            val.className = 'right';
            val.textContent = String(clamp5(it.v));
            row.append(name, bar, val);
            grid.appendChild(row);
          });
        } else {
          const memberId = SETTINGS.activeMemberId;
          const isPeerView = PEER_MODE.active && PEER_MODE.revieweeId === memberId;
          const reviewerId = PEER_MODE.reviewerId;

          (cat.items||[]).forEach((it,iIdx)=>{
            if(search && !it.n.toLowerCase().includes(search) && !cat.name.toLowerCase().includes(search)){
              return;
            }
            const row = document.createElement('div');
            row.className = 'row';

            const name = document.createElement('div');
            name.className = 'name';
            name.textContent = it.n;
            if(!isPeerView){
              name.title = 'Klick zum Umbenennen';
            }

            const val = document.createElement('div');
            val.className = 'right';

            const del = document.createElement('button');
            del.className = 'del';
            del.textContent = '✕';
            del.title = 'Skill entfernen';

            const sliderWrap = document.createElement('div');
            sliderWrap.className = 'slider';
            const range = document.createElement('input');
            range.type='range'; range.min='0'; range.max='5'; range.step='1';

            let baseValue = clamp5(it.v);
            let sliderValue = baseValue;

            if(isPeerView){
              const peerVal = getPeerRating(reviewerId, memberId, cat.name, it.n);
              if(peerVal!=null) sliderValue = peerVal;
            }

            range.value = String(sliderValue);
            range.className='range';
            range.style.setProperty('--value', pct5(range.value) + '%');
            sliderWrap.appendChild(range);

            const deltaBox = document.createElement('div');
            deltaBox.style.gridColumn = '1 / -1';
            deltaBox.style.display = 'flex';
            deltaBox.style.justifyContent = 'flex-end';
            deltaBox.style.gap = '6px';

            function updateDeltas(currentSliderVal){
              deltaBox.innerHTML = '';
              const selfVal = isPeerView ? baseValue : currentSliderVal;

              // Peer-Δ: immer anzeigen, wenn es Peer-Daten gibt (auch bei 0)
              if (showPeerDelta) {
                if (isPeerView) {
                  const d = currentSliderVal - baseValue;
                  deltaBox.appendChild(makePeerBadge(d));
                } else {
                  const avgPeer = peerAverageForReviewee(memberId, cat.name, it.n);
                  if (avgPeer != null) {
                    const d = avgPeer - selfVal;
                    deltaBox.appendChild(makePeerBadge(d));
                  }
                }
              }

              // Ref-Δ: gleiche Logik – Anzeige auch bei 0
              if (showRefDelta && refLevel && roleKey) {
                const rv = getRefVal(roleKey, refLevel, cat.name, it.n);
                if (rv != null) {
                  const d = selfVal - rv;
                  deltaBox.appendChild(makeRefBadge(d, rv, refLevel));
                }
              }
            }

            if(!isPeerView){
              val.textContent = String(baseValue);
              val.title = 'Klick zum Bearbeiten';
              val.onclick = ()=>{
                const neu = prompt('Neuer Wert (0–5):', String(it.v));
                if(neu==null) return;
                it.v = clamp5(parseInt(neu,10)||0);
                range.value = String(it.v);
                range.style.setProperty('--value', pct5(it.v) + '%');
                val.textContent = String(it.v);
                const prof = ensureProfile(memberId);
                prof.meta.updated = new Date().toISOString();
                scheduleSave();
                recalcSummary();
                updateDeltas(it.v);
              };

              name.onclick = ()=>{
                const current = it.n;
                const neu = prompt('Neuer Skill-Name:', current);
                if(!neu || !neu.trim() || neu.trim() === current) return;
                const confirmChange = confirm('Bist du sicher, dass du diesen Skill-Namen ändern willst?');
                if(!confirmChange) return;
                it.n = neu.trim();
                const prof = ensureProfile(memberId);
                prof.meta.updated = new Date().toISOString();
                propagateRoleStructureFromMember(memberId);
                renderCategories();
              };

              del.onclick = ()=>{
                if(!confirm(`„${it.n}“ aus Kategorie „${cat.name}“ entfernen?`)) return;
                cat.items.splice(iIdx,1);
                const prof = ensureProfile(memberId);
                prof.meta.updated = new Date().toISOString();
                propagateRoleStructureFromMember(memberId);
                renderCategories();
              };

              updateDeltas(baseValue);
            } else {
              const peerVal = getPeerRating(reviewerId, memberId, cat.name, it.n);
              const usedVal = peerVal!=null ? peerVal : baseValue;
              range.value = String(usedVal);
              range.style.setProperty('--value', pct5(usedVal) + '%');
              val.textContent = String(usedVal);
              del.disabled = true;
              name.style.opacity = 0.9;
              name.title = 'Im Peer-Review-Modus ist der Name gesperrt.';
              val.title = 'Im Peer-Review-Modus bearbeitest du nur deine Bewertung.';
              updateDeltas(usedVal);
            }

            range.addEventListener('input', e=>{
              const v = clamp5(parseInt(e.target.value,10)||0);
              range.style.setProperty('--value', pct5(v) + '%');
              if(isPeerView){
                setPeerRating(reviewerId, memberId, cat.name, it.n, v);
                val.textContent = String(v);
                scheduleSave();
                updateDeltas(v);
              } else {
                it.v = v;
                val.textContent = String(v);
                const prof = ensureProfile(memberId);
                prof.meta.updated = new Date().toISOString();
                scheduleSave();
                recalcSummary();
                updateDeltas(v);
                showHint(range, it.n, v);
              }
            });

            const id = `s-${Math.random().toString(36).slice(2)}`;
            range.id = id;
            const lab = document.createElement('label');
            lab.className='sr-only';
            lab.setAttribute('for', id);
            lab.textContent = it.n;
            sliderWrap.prepend(lab);

            row.append(name, val, del, sliderWrap, deltaBox);
            grid.appendChild(row);
          });
        }

        section.appendChild(grid);
        root.appendChild(section);
      });

      if(!categories.length){
        const note = document.createElement('div');
        note.className='tag';
        note.style.marginTop='8px';
        note.textContent = isTeamView
          ? 'Noch keine Skills erfasst. Wechsle in ein Mitglieder-Profil, um Skills hinzuzufügen.'
          : (PEER_MODE.active ? 'Keine Skills vorhanden, die du bewerten könntest.' : 'Noch keine Kategorien. Nutze „+ Kategorie“, um zu starten.');
        root.appendChild(note);
      }
    }

    // ---------------------------
    // PDF / Druck
    // ---------------------------
    function pdfSkillBar(val, teamColor){
      const W=160, H=10;
      const w = Math.max(0, Math.min(W, Math.round((clamp5(val)/5)*W)));
      const col = teamColor || '#7aa2ff';
      return `
<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" aria-label="Skillbalken">
  <rect x="0" y="0" width="${W}" height="${H}" rx="5" ry="5" fill="#11152b" stroke="rgba(0,0,0,.35)"/>
  <rect x="0.5" y="0.5" width="${Math.max(0,w-1)}" height="${H-1}" rx="4.5" ry="4.5" fill="${col}"/>
</svg>`;
    }

    function pdfCategoryAvgBar(avg, teamColor){
      const W=100, H=8;
      const w = Math.max(0, Math.min(W, Math.round((clamp(avg,0,5)/5)*W)));
      const col = darkerHex(teamColor || '#7aa2ff', 0.6);
      return `
<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" aria-label="Kategorie-Ø">
  <rect x="0" y="0" width="${W}" height="${H}" rx="4" ry="4" fill="#f0f2f7" stroke="#d0d4e0"/>
  <rect x="0.5" y="0.5" width="${Math.max(0,w-1)}" height="${H-1}" rx="3.5" ry="3.5" fill="${col}"/>
</svg>`;
    }

    function buildPdfSheetTeam(profile, title, teamColor){
      const rows=[];
      (profile.categories||[]).forEach(c=>{
        const xs = c.items || [];
        const sum = xs.reduce((s,it)=>s+(Number(it.v)||0),0);
        const avg = xs.length ? (sum/xs.length) : 0;
        rows.push(`<tr class="pdf-cat">
  <td>${escapeHtml(c.name)}</td>
  <td>Ø ${avg.toFixed(1)} (0–5)</td>
  <td></td>
  <td class="bars-cell">${pdfCategoryAvgBar(avg, teamColor)}</td>
</tr>`);
        xs.forEach(it=>{
          const v = clamp5(it.v);
          rows.push(`<tr>
  <td></td>
  <td>${escapeHtml(it.n)}</td>
  <td class="val-cell">${v}</td>
  <td class="bars-cell">${pdfSkillBar(v, teamColor)}</td>
</tr>`);
        });
      });

      return `
      <div class="sheet">
        <h2>${escapeHtml(title)} — Team-Skills (0–5)</h2>
        <table class="pdf-table" aria-label="Skills-Tabelle">
          <thead>
            <tr>
              <th>Kategorie</th>
              <th>Skill / Ø</th>
              <th>Wert</th>
              <th>Balken</th>
            </tr>
          </thead>
          <tbody>${rows.join('\n')}</tbody>
        </table>
      </div>`;
    }

    function buildPdfSheetMember(memberId, member, team, profile, opts){
      const teamColor = opts.teamColor;
      const roleKey   = opts.roleKey;
      const refLevel  = opts.refLevel;
      const showRef   = opts.showRefDelta;
      const showPeer  = opts.showPeerDelta;

      const rows=[];
      (profile.categories||[]).forEach(c=>{
        const xs = c.items || [];
        const sum = xs.reduce((s,it)=>s+(Number(it.v)||0),0);
        const avg = xs.length ? (sum/xs.length) : 0;

        rows.push(`<tr class="pdf-cat">
  <td>${escapeHtml(c.name)}</td>
  <td>Ø ${avg.toFixed(1)} (0–5)</td>
  ${showRef ? '<td></td><td></td>' : ''}
  ${showPeer ? '<td></td>' : ''}
  <td class="bars-cell">${pdfCategoryAvgBar(avg, teamColor)}</td>
</tr>`);

        xs.forEach(it=>{
          const v = clamp5(it.v);
          let refVal=null, dRef=null, peerAvg=null, dPeer=null;
          if(showRef && refLevel && roleKey){
            refVal = getRefVal(roleKey, refLevel, c.name, it.n);
            if(refVal!=null){
              dRef = v - refVal;
              if(dRef===0) dRef = null;
            }
          }
          if(showPeer){
            peerAvg = peerAverageForReviewee(memberId, c.name, it.n);
            if(peerAvg!=null){
              dPeer = peerAvg - v;
              if(dPeer===0) dPeer = null;
            }
          }

          rows.push(`<tr>
  <td></td>
  <td>${escapeHtml(it.n)}</td>
  ${showRef ? `<td class="val-cell">${refVal!=null?refVal:''}</td><td class="val-cell">${dRef!=null?((dRef>0?'+':'')+dRef):''}</td>` : ''}
  ${showPeer ? `<td class="val-cell">${dPeer!=null?((dPeer>0?'+':'')+dPeer):''}</td>` : ''}
  <td class="bars-cell">${pdfSkillBar(v, teamColor)}</td>
</tr>`);
        });
      });

      const refInfo = (showRef && refLevel) ? ` – Ref: ${refLevel}` : '';
      const peerInfo = showPeer ? ' – Peer‑Δ aktiviert' : '';
      const subtitleInfo = [refInfo, peerInfo].filter(Boolean).join('');

      return `
      <div class="sheet">
        <h2>${escapeHtml(member.name)} (${escapeHtml(team.name||'Team')}) — Skills (0–5)${escapeHtml(subtitleInfo)}</h2>
        <table class="pdf-table" aria-label="Skills-Tabelle">
          <thead>
            <tr>
              <th>Kategorie</th>
              <th>Skill / Ø</th>
              ${showRef ? `<th>Ref (${escapeHtml(refLevel||'')})</th><th>Δ Ref</th>` : ''}
              ${showPeer ? '<th>Δ Peer</th>' : ''}
              <th>Balken</th>
            </tr>
          </thead>
          <tbody>${rows.join('\n')}</tbody>
        </table>
      </div>`;
    }

    async function renderPdfAndPrint(){
      const root = byId('print-root');
      const team = getActiveTeam();
      if(!team){
        alert('Kein Team ausgewählt.');
        return;
      }
      const teamColor = team.color || '#7aa2ff';
      const memberId = SETTINGS.activeMemberId;

      let html = '';
      if(!memberId){
        const profile = computeTeamAggregatedProfile(team);
        html = buildPdfSheetTeam(profile, team.name || 'Team', teamColor);
      } else {
        const member = findMemberById(memberId);
        const profile = ensureProfile(memberId);
        const meta = profile.meta || {};
        const roleKey = resolveRoleKey(member, profile);
        const refLevel = meta.refLevel || '';
        const showRef = meta.showRefDelta !== false;
        const showPeer = meta.showPeerDelta !== false;

        html = buildPdfSheetMember(memberId, member, team, profile, {
          teamColor,
          roleKey,
          refLevel,
          showRefDelta: showRef,
          showPeerDelta: showPeer
        });
      }

      root.innerHTML = `
        <style>
          body{background:white;color:#111;font-family:system-ui, sans-serif;}
          .sheet{page-break-after:always;margin-bottom:24px;}
          .sheet h2{font-size:18px;margin-bottom:8px;}
          .pdf-table{border-collapse:collapse;width:100%;font-size:12px;}
          .pdf-table th,.pdf-table td{border:1px solid #ccc;padding:4px 6px;}
          .pdf-cat td{background:#f3f4f8;font-weight:bold;}
          .val-cell{text-align:center;width:40px;}
          .bars-cell{width:200px;}
        </style>
        ${html}
      `;
      window.print();
      setTimeout(()=>{ root.innerHTML=''; }, 500);
    }

    // ---------------------------
    // Team-Dialog
    // ---------------------------
    function buildMemberRow(id, name, roleKeyOrLabel){
      const row = document.createElement('div');
      row.className = 'dialog-row';
      row.style.display='grid';
      row.style.gridTemplateColumns='1.5fr 1.2fr auto';
      row.style.gap='8px';
      row.dataset.memberId = id;

      const nameInput = document.createElement('input');
      nameInput.className='search';
      nameInput.placeholder='Name';
      nameInput.value = name || '';

      // ggf. Rolle aus Label rekonstruieren
      const rolesObj = SETTINGS.roles || {};
      if(roleKeyOrLabel){
        const label = roleKeyOrLabel;
        let hasKey = !!rolesObj[roleKeyOrLabel];
        if(!hasKey){
          for(const key of Object.keys(rolesObj)){
            if(rolesObj[key].label === label){
              roleKeyOrLabel = key;
              hasKey = true;
              break;
            }
          }
        }
        if(!hasKey){
          roleKeyOrLabel = ensureRoleExistsForLabel(label);
        }
      }

      const roleSelect = document.createElement('select');
      roleSelect.className='search';
      const roles = getAllRoles();
      roleSelect.innerHTML = '';
      const optEmpty = document.createElement('option');
      optEmpty.value='';
      optEmpty.textContent='Rolle wählen…';
      roleSelect.appendChild(optEmpty);
      roles.forEach(r=>{
        const opt=document.createElement('option');
        opt.value=r.key;
        opt.textContent=r.label;
        roleSelect.appendChild(opt);
      });

      let selectedKey = '';
      if(roleKeyOrLabel){
        if(rolesObj[roleKeyOrLabel]){
          selectedKey = roleKeyOrLabel;
        } else {
          for(const r of roles){
            if(r.label === roleKeyOrLabel){ selectedKey = r.key; break; }
          }
        }
      }
      roleSelect.value = selectedKey;

      const del = document.createElement('button');
      del.textContent='✕';
      del.title='Mitglied entfernen';
      del.onclick = ()=> row.remove();

      row.append(nameInput, roleSelect, del);
      return row;
    }

    function buildTeamDialog(){
      let team = getActiveTeam();
      if(!team){
        createTeam('Neues Team');
        team = getActiveTeam();
      }
      const nameInput = byId('team-name-input');
      const colorInput = byId('team-color-input');
      const square = byId('team-color-square');
      const list = byId('team-members-list');

      nameInput.value = team.name || '';
      colorInput.value = team.color || '#ffd166';
      square.style.background = team.color || '#ffd166';

      list.innerHTML = '';
      (team.members || []).forEach(m=>{
        list.appendChild(buildMemberRow(m.id, m.name, m.role));
      });
    }

    function openTeamDialog(){
      buildTeamDialog();
      byId('dlg-team').showModal();
    }

    async function saveTeamDialog(){
      const team = getActiveTeam();
      if(!team) return;
      const nameInput = byId('team-name-input');
      const colorInput = byId('team-color-input');
      const square = byId('team-color-square');
      const list = byId('team-members-list');

      const rows = [...list.children];
      const oldIds = (team.members || []).map(m => m.id);
      const oldActive = team.activeMemberId || null;

      const memberDefs = rows.map(row => {
        const id = row.dataset.memberId || newId('member');
        const inputs = row.querySelectorAll('input.search, select.search');
        const nameInput = inputs[0];
        const roleSelect = inputs[1];
        const name = (nameInput?.value || '').trim();
        if(!name) return null;
        const rawRoleKey = roleSelect.value || '';
        const roles = SETTINGS.roles || {};
        let displayRole = '';
        if(rawRoleKey){
          displayRole = (roles[rawRoleKey] && roles[rawRoleKey].label) || rawRoleKey;
        }
        return { id, name, rawRoleKey, displayRole };
      }).filter(Boolean);

      for(const def of memberDefs){
        const existed = oldIds.includes(def.id);
        if(def.rawRoleKey && !existed){
          await applyRoleTemplateToMember(def.id, def.rawRoleKey);
        }
        const prof = ensureProfile(def.id);
        prof.meta.owner = def.name;
        prof.meta.role  = def.rawRoleKey;
        prof.meta.updated = new Date().toISOString();
      }

      team.name = nameInput.value.trim() || 'Team';
      team.color = colorInput.value || '#ffd166';
      team.members = memberDefs.map(d=>({ id:d.id, name:d.name, role:d.displayRole || '' }));

      const newIds = team.members.map(m=>m.id);
      const createdIds = newIds.filter(id => !oldIds.includes(id));

      oldIds.forEach(id=>{
        if(!newIds.includes(id) && SETTINGS.data && SETTINGS.data[id]){
          delete SETTINGS.data[id];
        }
      });

      if(createdIds.length){
        const newActiveId = createdIds[createdIds.length - 1];
        team.activeMemberId = newActiveId;
        SETTINGS.activeMemberId = newActiveId;
      } else if (oldActive && !newIds.includes(oldActive)) {
        team.activeMemberId = null;
        SETTINGS.activeMemberId = null;
      }

      square.style.background = team.color;

      scheduleSave();
      byId('dlg-team').close();
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    function buildTeamFilterDialog(){
      const team = getActiveTeam();
      if(!team) return;
      const host = byId('team-filter-list');
      host.innerHTML='';
      const members = getMembers(team);
      const selected = new Set(selectedMemberIds(team));

      members.forEach(m=>{
        const label = document.createElement('label');
        label.style.display='grid';
        label.style.gridTemplateColumns='auto 1fr';
        label.style.alignItems='center';
        label.style.gap='8px';

        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.dataset.memberId = m.id;
        cb.checked = selected.size ? selected.has(m.id) : true;

        const span = document.createElement('span');
        span.textContent = m.name + (m.role ? ` (${m.role})` : '');

        label.append(cb, span);
        host.appendChild(label);
      });
    }

    function saveTeamFilterDialog(){
      const team = getActiveTeam();
      if(!team) return;
      const list = byId('team-filter-list');
      const cbs = [...list.querySelectorAll('input[type="checkbox"]')];
      const checkedIds = cbs.filter(cb=>cb.checked).map(cb=>cb.dataset.memberId);
      const allIds = getMembers(team).map(m=>m.id);
      if(!checkedIds.length){
        alert('Mindestens ein Mitglied muss im Filter bleiben.');
        return;
      }
      team.filterMemberIds = (checkedIds.length === allIds.length) ? null : checkedIds;
      scheduleSave();
      byId('dlg-team-filter').close();
      renderCategories();
    }

    // ---------------------------
    // Export / Import
    // ---------------------------
    function exportJson(){
      const blob = new Blob([JSON.stringify(SETTINGS, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      const date = new Date().toISOString().slice(0,10);
      a.href = URL.createObjectURL(blob);
      a.download = `settings_backup_${date}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJson(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          SETTINGS = migrateSettings(obj);
          exitPeerMode();
          scheduleSave();
          renderTeamTabs();
          renderMemberTabs();
          updateHeader();
          renderCategories();
        }catch(e){
          alert('Import fehlgeschlagen: ' + e.message);
        }
      };
      reader.readAsText(file);
    }

    // ---------------------------
    // Add Skill / Kategorie
    // ---------------------------
    function openAddSkillDialog(){
      const team = getActiveTeam();
      if(!team || !SETTINGS.activeMemberId || PEER_MODE.active){
        alert('Skills können nur im normalen Profil-Modus bearbeitet werden (nicht im Team- oder Peer-Modus).');
        return;
      }
      const prof = ensureProfile(SETTINGS.activeMemberId);
      if(!prof.categories.length){
        prof.categories.push({name:'Kategorie', items:[]});
        activeCategoryIdx = 0;
      }
      const cat = prof.categories[activeCategoryIdx] || prof.categories[0];
      byId('add-skill-cat-name').textContent = cat.name;
      byId('add-skill-name').value = '';
      byId('add-skill-val').value = '0';
      byId('dlg-add-skill').showModal();
    }

    function confirmAddSkillDialog(){
      const name = byId('add-skill-name').value.trim();
      const val  = clamp5(parseInt(byId('add-skill-val').value,10)||0);
      if(!name){
        alert('Bitte Skill-Namen eingeben.');
        return;
      }
      const memberId = SETTINGS.activeMemberId;
      const prof = ensureProfile(memberId);
      if(!prof.categories.length){
        prof.categories.push({name:'Kategorie', items:[]});
        activeCategoryIdx = 0;
      }
      const cat = prof.categories[activeCategoryIdx] || prof.categories[0];
      cat.items.push({n:name, v:val});
      prof.meta.updated = new Date().toISOString();
      propagateRoleStructureFromMember(memberId);
      byId('dlg-add-skill').close();
      renderCategories();
    }

    function addCategory(){
      const team = getActiveTeam();
      if(!team || !SETTINGS.activeMemberId || PEER_MODE.active){
        alert('Kategorien können nur im normalen Profil-Modus angelegt werden.');
        return;
      }
      const name = prompt('Name der neuen Kategorie:','Neue Kategorie');
      if(!name || !name.trim()) return;
      const memberId = SETTINGS.activeMemberId;
      const prof = ensureProfile(memberId);
      prof.categories.push({name:name.trim(), items:[]});
      prof.meta.updated = new Date().toISOString();
      activeCategoryIdx = prof.categories.length-1;
      propagateRoleStructureFromMember(memberId);
      renderCategories();
    }

    function collapseAll(){
      document.querySelectorAll('.category .grid').forEach(g=> g.style.display='none');
    }

    function expandAll(){
      document.querySelectorAll('.category .grid').forEach(g=> g.style.display='grid');
    }

    // ---------------------------
    // Rollen erstellen (ohne Kategorien)
    // ---------------------------
    function createNewRoleFromCurrentProfile(){
      const memberId = SETTINGS.activeMemberId;
      if(!memberId){
        alert('Rollen können nur aus einem Profil (nicht in der Team-Ansicht) erzeugt werden.');
        return;
      }
      if(PEER_MODE.active){
        alert('Im Peer-Review-Modus kann keine Rolle erstellt werden.');
        return;
      }
      const prof = ensureProfile(memberId);
      const m = findMemberById(memberId);
      const defaultKey = (prof.meta.role || '').replace(/\s+/g,'') || 'NeueRolle';
      const roleKeyInput = prompt('Kurzname der Rolle (Dateiname, z.B. UXLead):', defaultKey);
      if(!roleKeyInput) return;
      const safeKey = roleKeyInput.trim().replace(/[^a-z0-9_\-]/gi,'');
      if(!safeKey){
        alert('Ungültiger Rollen-Key. Nur Buchstaben/Zahlen/Unterstrich/Minus.');
        return;
      }
      const labelInput = prompt('Anzeigename der Rolle (z.B. UX Lead):', prof.meta.role || safeKey) || safeKey;

      if(!SETTINGS.roles || typeof SETTINGS.roles!=='object') SETTINGS.roles = {};
      if(!SETTINGS.roles[safeKey]){
        SETTINGS.roles[safeKey] = { label: labelInput, refs:{} };
        REF_LEVELS.forEach(l=>{
          SETTINGS.roles[safeKey].refs[l] = {};
        });
      } else {
        SETTINGS.roles[safeKey].label = labelInput;
      }

      const tmpl = {
        roleKey: safeKey,
        label: labelInput,
        categories: []
      };
      saveRoleTemplate(safeKey, tmpl);

      prof.meta.role = safeKey;
      prof.meta.updated = new Date().toISOString();
      if(m){
        m.role = labelInput;
      }

      scheduleSave();
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();
    }

    // ---------------------------
    // Referenz-Dialog
    // ---------------------------
    let REF_EDITOR_TEMPLATE = { roleKey:null, categories:[] };

    async function openRefDialog(){
      const roleSelect = byId('ref-role-select');
      const levelSelect = byId('ref-level-select');
      const searchInput = byId('ref-search');

      const roles = getAllRoles();
      roleSelect.innerHTML='';
      roles.forEach(r=>{
        const opt=document.createElement('option');
        opt.value=r.key;
        opt.textContent=r.label;
        roleSelect.appendChild(opt);
      });
      if(!roles.length){
        alert('Es sind noch keine Rollen definiert.');
        return;
      }

      let defaultRoleKey = roles[0].key;
      const memberId = SETTINGS.activeMemberId;
      if(memberId){
        const m = findMemberById(memberId);
        const prof = ensureProfile(memberId);
        const rk = resolveRoleKey(m, prof);
        if(rk && SETTINGS.roles[rk]) defaultRoleKey = rk;
      }

      roleSelect.value = defaultRoleKey;
      levelSelect.value = 'Senior';
      searchInput.value = '';

      REF_EDITOR_TEMPLATE = await loadRoleTemplate(defaultRoleKey);
      renderRefEditorGrid();

      byId('dlg-ref').showModal();
    }

    function renderRefEditorGrid(){
      const roleSelect = byId('ref-role-select');
      const levelSelect = byId('ref-level-select');
      const searchInput = byId('ref-search');
      const host = byId('ref-editor-grid');

      const roleKey = roleSelect.value;
      const level = levelSelect.value;
      const filter = (searchInput.value || '').trim().toLowerCase();

      if(!roleKey){
        host.innerHTML='<div class="note">Keine Rolle ausgewählt.</div>';
        return;
      }

      const cats = REF_EDITOR_TEMPLATE.categories || [];
      if(!cats.length){
        host.innerHTML='<div class="note">Diese Rolle hat noch keine Skills. Lege zuerst Kategorien &amp; Skills im Profil an.</div>';
        return;
      }

      const refs = ensureRoleRefs(roleKey);
      const mapLevel = refs[level];

      host.innerHTML = '';

      cats.forEach(cat=>{
        const catName = cat.name || '';
        const items = cat.items || [];

        const filteredItems = items.filter(it=>{
          const skName = it.n || '';
          if(!filter) return true;
          const cMatch = catName.toLowerCase().includes(filter);
          const sMatch = skName.toLowerCase().includes(filter);
          return cMatch || sMatch;
        });

        if(!filteredItems.length) return;

        const catBlock = document.createElement('div');
        catBlock.style.marginBottom = '12px';

        const catHeader = document.createElement('div');
        catHeader.textContent = catName;
        catHeader.style.fontWeight = '600';
        catHeader.style.color = '#cdd5ff';
        catHeader.style.marginBottom = '4px';

        const list = document.createElement('div');
        list.style.display = 'grid';
        list.style.gridTemplateColumns = '1.6fr auto';
        list.style.gap = '4px 10px';

        filteredItems.forEach(it=>{
          const skName = it.n || '';
          const key = skillKey(catName, skName);
          const current = typeof mapLevel[key]==='number' ? clamp5(mapLevel[key]) : (REF_DEFAULTS[level]||0);

          const skLabel = document.createElement('div');
          skLabel.textContent = skName;

          const inputWrap = document.createElement('div');
          const inp = document.createElement('input');
          inp.type='number';
          inp.min='0';
          inp.max='5';
          inp.step='1';
          inp.value = String(current);
          inp.className='search';
          inp.style.width='80px';
          inp.addEventListener('input', ()=>{
            const v = clamp5(parseInt(inp.value,10)||0);
            mapLevel[key] = v;
            scheduleSave();
          });

          inputWrap.appendChild(inp);
          list.append(skLabel, inputWrap);
        });

        catBlock.append(catHeader, list);
        host.appendChild(catBlock);
      });

      if(!host.children.length){
        host.innerHTML='<div class="note">Keine Einträge für diesen Filter.</div>';
      }
    }

    // ---------------------------
    // Init & Events
    // ---------------------------
    async function init(){
      await loadSettings();
      if(!SETTINGS.teams.length){
        createTeam('Neues Team');
      }
      if(!SETTINGS.activeTeamId && SETTINGS.teams.length){
        SETTINGS.activeTeamId = SETTINGS.teams[0].id;
      }
      renderTeamTabs();
      renderMemberTabs();
      updateHeader();
      renderCategories();

      byId('btn-new-team').onclick = ()=> createTeam('Neues Team');

      byId('btn-team-manage').onclick = ()=> openTeamDialog();
      byId('team-add-member').onclick = ()=>{
        const list = byId('team-members-list');
        const row = buildMemberRow(newId('member'), 'Neues Mitglied', '');
        list.appendChild(row);
      };
      byId('team-cancel').onclick = ()=> byId('dlg-team').close();
      byId('team-save').onclick = ()=> saveTeamDialog();
      byId('team-delete').onclick = ()=>{
        const team = getActiveTeam();
        if(!team) return;
        if(!confirm(`Team „${team.name}“ wirklich löschen?`)) return;
        byId('dlg-team').close();
        deleteTeam(team.id);
      };

      const colorSquare = byId('team-color-square');
      const colorInput  = byId('team-color-input');
      colorSquare.onclick = ()=>{
        colorInput.click();
      };
      colorInput.oninput = ()=>{
        colorSquare.style.background = colorInput.value;
      };

      byId('btn-team-filter').onclick = ()=>{
        const team = getActiveTeam();
        if(!team){
          alert('Kein Team ausgewählt.');
          return;
        }
        buildTeamFilterDialog();
        byId('dlg-team-filter').showModal();
      };
      byId('filter-all').onclick = ()=>{
        byId('team-filter-list').querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = true);
      };
      byId('filter-none').onclick = ()=>{
        byId('team-filter-list').querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
      };
      byId('filter-cancel').onclick = ()=> byId('dlg-team-filter').close();
      byId('filter-save').onclick = ()=> saveTeamFilterDialog();

      byId('btn-add-skill').onclick = ()=> openAddSkillDialog();
      byId('add-skill-cancel').onclick = ()=> byId('dlg-add-skill').close();
      byId('add-skill-confirm').onclick = ()=> confirmAddSkillDialog();

      byId('btn-add-cat').onclick = ()=> addCategory();

      byId('btn-collapse').onclick = ()=> collapseAll();
      byId('btn-expand').onclick = ()=> expandAll();

      byId('btn-export-json').onclick = ()=> exportJson();
      byId('btn-import').onclick = ()=> byId('import-file').click();
      byId('import-file').onchange = e=>{
        const f = e.target.files[0];
        if(f) importJson(f);
        e.target.value='';
      };

      byId('btn-pdf').onclick = ()=> renderPdfAndPrint();

      byId('search').addEventListener('input', ()=> renderCategories());

      byId('display-name').addEventListener('blur', ()=>{
        const text = byId('display-name').textContent.trim();
        if(!text) return;
        const team = getActiveTeam();
        if(!team) return;
        if(!SETTINGS.activeMemberId){
          team.name = text;
        }else{
          const m = findMemberById(SETTINGS.activeMemberId);
          if(m){
            m.name = text;
            const prof = ensureProfile(SETTINGS.activeMemberId);
            prof.meta.owner = text;
          }
        }
        scheduleSave();
        renderTeamTabs();
        renderMemberTabs();
        updateHeader();
      });

      byId('subtitle').addEventListener('input', ()=>{
        const memberId = SETTINGS.activeMemberId;
        if(!memberId) return;
        const prof = ensureProfile(memberId);
        prof.meta.subtitle = byId('subtitle').innerText;
        prof.meta.updated = new Date().toISOString();
        scheduleSave();
      });

      byId('btn-peer').onclick = ()=>{
        const team = getActiveTeam();
        if(!team){
          alert('Kein Team ausgewählt.');
          return;
        }
        if(getMembers(team).length < 2){
          alert('Peer-Review braucht mindestens zwei Mitglieder im Team.');
          return;
        }
        buildPeerDialog();
        byId('dlg-peer').showModal();
      };
      byId('peer-cancel').onclick = ()=> byId('dlg-peer').close();
      byId('peer-start').onclick = ()=>{
        const reviewerId = byId('peer-reviewer').value;
        const revieweeId = byId('peer-reviewee').value;
        if(!reviewerId || !revieweeId){
          alert('Bitte Bewerter:in und zu Bewertende:n auswählen.');
          return;
        }
        if(reviewerId === revieweeId){
          alert('Peer-Review auf sich selbst ist hier nicht vorgesehen.');
          return;
        }
        byId('dlg-peer').close();
        enterPeerMode(reviewerId, revieweeId);
      };

      byId('peer-pill').onclick = ()=> exitPeerMode();

      byId('btn-role-save').onclick = ()=> createNewRoleFromCurrentProfile();
      byId('btn-ref-edit').onclick = ()=> openRefDialog();
      byId('ref-role-select').addEventListener('change', async ()=>{
        REF_EDITOR_TEMPLATE = await loadRoleTemplate(byId('ref-role-select').value);
        renderRefEditorGrid();
      });
      byId('ref-level-select').addEventListener('change', ()=> renderRefEditorGrid());
      byId('ref-search').addEventListener('input', ()=> renderRefEditorGrid());
      byId('ref-fill-defaults').onclick = ()=>{
        const roleKey = byId('ref-role-select').value;
        const level   = byId('ref-level-select').value;
        if(!roleKey || !level) return;
        const cats = REF_EDITOR_TEMPLATE.categories || [];
        const refs = ensureRoleRefs(roleKey);
        const map = refs[level];
        const base = REF_DEFAULTS[level] || 0;
        cats.forEach(cat=>{
          (cat.items||[]).forEach(it=>{
            map[skillKey(cat.name, it.n)] = base;
          });
        });
        scheduleSave();
        renderRefEditorGrid();
      };
      byId('ref-cancel').onclick = ()=> byId('dlg-ref').close();
      byId('ref-save').onclick = ()=> byId('dlg-ref').close();

      const refSelect = byId('ref-view-level');
      const refToggle = byId('toggle-ref-delta');
      const peerToggle = byId('toggle-peer-delta');

      refSelect.onchange = ()=>{
        const memberId = SETTINGS.activeMemberId;
        if(!memberId) return;
        const prof = ensureProfile(memberId);
        prof.meta.refLevel = refSelect.value || '';
        prof.meta.updated = new Date().toISOString();
        scheduleSave();
        renderCategories();
      };
      refToggle.onchange = ()=>{
        const memberId = SETTINGS.activeMemberId;
        if(!memberId) return;
        const prof = ensureProfile(memberId);
        prof.meta.showRefDelta = !!refToggle.checked;
        prof.meta.updated = new Date().toISOString();
        scheduleSave();
        renderCategories();
      };
      peerToggle.onchange = ()=>{
        const memberId = SETTINGS.activeMemberId;
        if(!memberId) return;
        const prof = ensureProfile(memberId);
        prof.meta.showPeerDelta = !!peerToggle.checked;
        prof.meta.updated = new Date().toISOString();
        scheduleSave();
        renderCategories();
      };

      document.addEventListener('keydown', (e)=>{
        if(e.shiftKey && (e.key==='ArrowLeft' || e.key==='ArrowRight')){
          const active=document.activeElement;
          if(active && active.classList.contains('range')){
            e.preventDefault();
            const step=(e.key==='ArrowLeft' ? -1 : +1);
            active.value=String(clamp5(parseInt(active.value,10)+step));
            active.dispatchEvent(new Event('input',{bubbles:true}));
          }
        }
      });
    }

    init();
  </script>
</body>
</html>
